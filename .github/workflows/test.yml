name: bootstrap
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: macos-13
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: 3.11
      - uses: pre-commit/action@v3.0.0

      - name: remove homebrew
        run: |
          # This takes too long (over a minute), so we just rm -rf the important stuff
          # brew list | xargs brew uninstall --force
          sudo rm -rf \
            /usr/local/bin/brew /usr/local/Homebrew /usr/local/Cellar /usr/local/Caskroom \
            /usr/local/bin/pydoc* /usr/local/bin/python* /usr/local/bin/2to3* /usr/local/bin/idle3* \
            /usr/local/bin/chromedriver

      - name: install
        shell: bash -i -euo pipefail {0}
        env:
          SHELL: bash
        run: |
          mv install-devenv.sh /tmp
          cd /tmp
          # should be able to be run from anywhere
          ./install-devenv.sh "${{ github.event.pull_request && github.head_ref || github.ref_name }}"

          # skips initial interactive config setup
          mkdir -p ~/.config/sentry-devenv
          cat <<EOF > ~/.config/sentry-devenv/config.ini
          [devenv]
          coderoot = $HOME/dev
          EOF

      - name: test
        shell: bash -i -euo pipefail {0}
        env:
          SHELL: bash
        run: |
          devenv --nocoderoot doctor --check-only || touch foo
          devenv --nocoderoot doctor --check-only
          rm foo
          expect <<EOF
            spawn devenv --nocoderoot doctor
            expect "Do you want to attempt to fix foo? (Y/n): "
            send "y\r"
            expect eof
          EOF
          devenv --nocoderoot doctor

      - name: bootstrap
        shell: bash -i -euo pipefail {0}
        env:
          SHELL: bash
        run: |
          # we don't have permissions to clone getsentry which is a good thing
          # eventually we should move this bootstrap testing over to getsentry repo
          # in the meantime, mock it so that pip install -e has something to chew on
          mkdir -p $HOME/dev/getsentry
          cat <<EOF > $HOME/dev/getsentry/pyproject.toml
          [project]
          name = "getsentry-mock"
          version = "0.0.0"
          EOF

          # note: colima will be used and is necessary for a docker runtime on
          #       macos GitHub runners
          devenv bootstrap

          cd $HOME/dev/sentry
          direnv allow
